{"version":3,"file":"mqtt.js","sourceRoot":"","sources":["../../../lib/drivers/mqtt.ts"],"names":[],"mappings":"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","sourcesContent":["import { Client } from 'paho-mqtt/src/paho-mqtt'\nimport { EventEmitter } from 'tiny-events'\n\nimport { logger as Logger } from '../log'\nimport { ISocket, IDriver } from './index'\nimport msgpack from 'msgpack-lite'\nimport {\n\tILogger,\n\tISocketOptions,\n\tICallback,\n\tISubscription,\n\tICredentials\n} from '../../interfaces'\n\n// @ts-ignore\nexport class MQTTDriver extends EventEmitter implements ISocket, IDriver {\n  logger: ILogger\n  config: ISocketOptions\n  socket: any\n  constructor ({ host = 'localhost', path = '/', integrationId, config, logger = Logger, ...moreConfigs }: any) {\n    super()\n    host = 'localhost'\n    const [, _host = host, , port = 8081] = new RegExp('(.*?)(:([0-9]+))?$').exec(host || 'localhost:3000') || []\n    this.config = {\n      ...config,\n      ...moreConfigs,\n      host: _host.replace(/^http/, 'ws'),\n      timeout: 20000,\n      port: port\n\t\t\t// reopen: number\n\t\t\t// ping: number\n\t\t\t// close: number\n\t\t\t// integration: string\n    }\n\n    this.logger = logger\n\n    if (/https/.test(host)) {\n      this.socket = new Client(this.config.host + path, 'clientId')\n    } else {\n      this.socket = new Client((this.config.host || '').replace('http://', '').replace('ws://', ''), Number(port), path, 'clientId')\n    }\n    this.socket.onMessageArrived = ({ destinationName, payloadBytes }: any) => {\n      if (/room-message/.test(destinationName)) {\n        this.emit('message', { topic: destinationName, message: msgpack.decode(payloadBytes) })\n      }\n    }\n  }\n\n  connect (options: ISocketOptions): Promise<any> {\n    return new Promise((resolve, reject) => {\n      this.socket.connect({ userName: 'livechat-guest', password: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2Ijp7InZpc2l0b3JUb2tlbiI6ImFqamVvY2N5dXhweXVlOTg3YzJ0NnMifSwidXNlciI6eyJ2Ijp7InZpc2l0b3JUb2tlbiI6ImFqamVvY2N5dXhweXVlOTg3YzJ0NnMifX0sIm5hbWUiOiJKb2huIERvZSIsImlhdCI6MTUxNjIzOTAyMn0.RTQz72NTgI6qWgQMCNHHaSNS13sDK3cz--ss2_5vAz8'\t, onSuccess: resolve, onFailure: reject, useSSL: /https/.test(this.config.host || '') })\n    })\n  }\n  disconnect (): Promise<any> {\n    this.socket.end()\n    return Promise.resolve(this.socket)\n  }\n\n  subscribe (topic: string, { qos = 0 }: any): Promise<ISubscription> {\n    return new Promise((resolve, reject) => {\n      this.socket.subscribe(topic, { qos, onFailure: (...args: any[]) => {\n        console.log(...args)\n        reject(args)\n      }, onSuccess: (...args: any[]) => {\n        console.log(...args)\n        resolve(args as any)\n\t\t\t }\n      })\n    })\n  }\n\n  unsubscribe (subscription: ISubscription, ...args: any[]): Promise < ISocket > {\n    return new Promise((resolve, reject) => {\n      this.socket.unsubscribe(subscription.name, [...args, (err: any, granted: any) => {\n        if (err) {\n          return reject(err)\n        }\n        return resolve(granted)\n      }])\n    })\n  }\n\n  unsubscribeAll (): Promise < ISocket > {\n    return Promise.resolve() as any\n  }\n  subscribeNotifyAll (): Promise < any > {\n    return Promise.resolve() as any\n  }\n\n  subscribeLoggedNotify (): Promise < any > {\n    return Promise.resolve() as any\n  }\n\n  subscribeNotifyUser (): Promise < any > {\n    return Promise.resolve() as any\n  }\n\n  login (credentials: ICredentials, args ?: any): Promise < any > {\n    return Promise.resolve() as any\n  }\n\t// usertyping room-messages deleted messages\n  subscribeRoom (rid: string, ...args: any[]): Promise < ISubscription[] > {\n    return this.subscribe(`room-messages/${rid}`, { qos: 0 }) as any\n  }\n\n  onMessage (cb: ICallback): void {\n    this.on('message', ({ topic, message }: any) => {\n      if (/room-messages/.test(topic)) {\n        cb(message)// TODO apply msgpack\n      }\n    })\n  }\n  async onTyping (cb: ICallback): Promise < any > {\n    return new Promise((resolve) => {\n      resolve(this.on('notify-room', ({ fields: { args: [username, isTyping] } }: any) => {\n        cb(username, isTyping)\n      }))\n\n    })\n  }\n\n  notifyVisitorTyping (rid: string, username: string, typing: boolean, token: string): Promise<any> {\n    return Promise.resolve() as any\n  }\n\n  onStreamData (name: string, cb: ICallback): Promise<any> {\n    return Promise.resolve(this.on(name, ({ fields: { args: [message] } }: any) => cb((message)))) as any\n  }\n\n  methodCall = (method: string, ...args: any[]): Promise<any> => {\n    return Promise.resolve() as any\n  }\n}\n"]}