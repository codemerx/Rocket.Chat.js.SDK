{"version":3,"file":"start.js","sourceRoot":"","sources":["../../utils/start.ts"],"names":[],"mappings":"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","sourcesContent":["// Test script uses standard methods and env config to connect and log streams\nimport { botUser } from './config'\nimport { IMessage, ILogger } from '../interfaces'\nimport BotDriver from '../lib/clients/Bot'\n\nglobal.fetch = require('node-fetch')\n// Login settings - LDAP needs to be explicitly enabled\nexport let username = process.env.ROCKETCHAT_USER || 'g1'\nexport let password = process.env.ROCKETCHAT_PASSWORD || '1'\nexport let ldap = (process.env.ROCKETCHAT_AUTH === 'ldap')\n\n// Connection settings - Enable SSL by default if Rocket.Chat URL contains https\nexport let host = process.env.ROCKETCHAT_URL || 'http://localhost:3000'\nexport const useSsl = (process.env.ROCKETCHAT_USE_SSL && process.env.ROCKETCHAT_USE_SSL === 'true') || (host).toLowerCase().startsWith('https')\nexport let timeout = 20 * 1000 // 20 seconds\n\n// Respond settings - reactive callback filters for .respondToMessages\nexport let rooms = (process.env.ROCKETCHAT_ROOM)\n\t? (process.env.ROCKETCHAT_ROOM || '').split(',').map((room) => room.trim())\n\t: []\nexport let allPublic = (process.env.LISTEN_ON_ALL_PUBLIC || 'false').toLowerCase() === 'true'\nexport let dm = (process.env.RESPOND_TO_DM || 'false').toLowerCase() === 'true'\nexport let livechat = (process.env.RESPOND_TO_LIVECHAT || 'false').toLowerCase() === 'true'\nexport let edited = (process.env.RESPOND_TO_EDITED || 'false').toLowerCase() === 'true'\n\n// Message attribute settings\nexport let integrationId = process.env.INTEGRATION_ID || 'js.SDK'\n\n// Cache settings\nexport let roomCacheMaxSize = parseInt(process.env.ROOM_CACHE_SIZE || '10', 10)\nexport let roomCacheMaxAge = 1000 * parseInt(process.env.ROOM_CACHE_MAX_AGE || '300', 10)\nexport let dmCacheMaxSize = parseInt(process.env.DM_ROOM_CACHE_SIZE || '10', 10)\nexport let dmCacheMaxAge = 1000 * parseInt(process.env.DM_ROOM_CACHE_MAX_AGE || '100', 10)\n\n// Livechat settings\nexport let token = process.env.LIVECHAT_TOKEN || ''\nexport let rid = process.env.LIVECHAT_ROOM || ''\nexport let department = process.env.LIVECHAT_DEPARTMENT || ''\n\nconst delay = (ms: number) => new Promise((resolve, reject) => setTimeout(resolve, ms))\n\nclass L implements ILogger {\n  debug (...args: any[]) {\n    // console.log(...args)\n  }\n  info (...args: any[]) {\n    // console.log(...args)\n  }\n  warning (...args: any[]) {\n    // console.warn(...args)\n  }\n  warn (...args: any[]) { // legacy method\n    // return this.warning(...args)\n  }\n  error (...args: any[]) {\n    // console.error(...args)\n  }\n}\n\nconst driver = new BotDriver({ host, useSsl, timeout, logger: new L() } as any)\n// Start subscription to log message stream (used for e2e test and demo)\nasync function start () {\n  await driver.login({ username, password })\n  await driver.connect({})\n  // driver.subscribeNotifyAll()\n  // driver.subscribeLoggedNotify()\n  // driver.subscribeNotifyUser()\n\n  await driver.respondToMessages((err, msg, msgOpts) => {\n    if (err) throw err\n    console.log('[respond]', JSON.stringify(msg), JSON.stringify(msgOpts))\n    if (msg) demo(msg).catch((e) => console.error(e))\n  }, {\n    rooms: ['GENERAL'],\n    allPublic: false,\n    dm: true,\n    edited: true,\n    livechat: false\n  })\n}\n\n// Demo bot-style interactions\n// A: Listen for \"tell everyone <something>\" and send that something to everyone\n// B: Listen for \"who's online\" and tell that person who's online\nasync function demo (message: IMessage) {\n  if (!message.msg) return\n  if (/tell everyone/i.test(message.msg)) {\n    const match = message.msg.match(/tell everyone (.*)/i)\n    if (!match || !match[1]) return\n    // const sayWhat = `@${message.u!.username} says \"${match[1]}\"`\n\n    const usernames = await driver.users.allNames()\n    for (let username of usernames) {\n      if (username && username !== botUser.username) {\n\t\t\t\t// const toWhere =\n        await driver.getDirectMessageRoomId(username)\n        await delay(200) // delay to prevent rate-limit error\n      }\n    }\n  } else if (/who\\'?s online/i.test(message.msg)) {\n    const names = await driver.users.onlineNames()\n    const niceNames = names.join(', ').replace(/, ([^,]*)$/, ' and $1')\n    await driver.sendToRoomId(niceNames + ' are online', message.rid!)\n  }\n}\n\nstart().catch((e) => console.error(e))\n"]}